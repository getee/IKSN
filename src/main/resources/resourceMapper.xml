<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="group.first.iksn.model.dao.ResourceDAO">
<!-- 评价评分 -->
    <insert id="assessResource" parameterType="ResourceComments">
        insert into resourcecomments(uid,rid,star,comment) values (#{uid},#{rid},#{star},#{comment})
    </insert>
    <!-- 收藏资源 -->
    <insert id="collectResource" parameterType="CollectResource">
        insert into collectresource(uid,rid) values (#{uid},#{rid})
    </insert>
    <!-- 统计下载次数 -->
    <select id="downnum" resultType="Integer">
        select count(*) from downresources where RID=(#{rid})
    </select>
    <select id="checkFile" resultType="Resource">
        SELECT * FROM resource where MD5=#{0} and SHA=#{1}
    </select>
    <insert id="addResource" parameterType="Resource" keyProperty="rid" useGeneratedKeys="true">
        INSERT INTO resource(uid,name,md5,sha,path,scoring,classify,introduce,time) VALUES (#{uid},#{name},#{md5},#{sha},#{path},#{scoring},#{classify},#{introduce},#{time})
    </insert>

    <insert id="addResourceTag">
        <foreach collection="rtag" item="val" >
            INSERT INTO resourcetag(RID,RTAG) VALUES (#{rid},#{val});
        </foreach>
    </insert>

    <!--从reportBlog表中根据id删除一个选中行-->
    <delete id="deleteResourceFromReport" parameterType="ReportResource">
        delete from reportresource where id = #{id}
    </delete>
    <!--删除跟resource相关的表数据-->
    <delete id="deleteResourceOthers" parameterType="Resource">
        DELETE  rr,rt,rb,rc,cr,dr,ir from reportresource rr
          LEFT OUTER JOIN resourcetag rt ON rt.RID = rr.RID
          LEFT OUTER JOIN resourcebrowsed rb ON rb.RID = rr.RID
          LEFT OUTER JOIN resourcecomments rc ON rc.RID = rr.RID
          LEFT OUTER JOIN collectresource cr ON cr.RID = rr.RID
          LEFT OUTER JOIN downresources dr ON dr.RID = rr.RID
          LEFT OUTER JOIN illegalresource ir ON ir.RID = rr.RID
        where rr.RID = #{rid};
    </delete>
    <delete id="deleteResource" parameterType="Resource">
        delete from resource where RID=#{rid}
    </delete>
</mapper>